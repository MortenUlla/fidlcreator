<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>xAPI Gamify (Pages)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
    header{padding:16px;border-bottom:1px solid #eee;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .wrap{display:grid;grid-template-columns:380px 1fr;gap:0;height:calc(100vh - 66px)}
    aside{border-right:1px solid #eee;padding:16px;overflow:auto}
    main{height:100%;}
    iframe{width:100%;height:100%;border:0;background:#111}
    .btn{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
    .muted{color:#777}
    .row{display:flex;gap:8px;align-items:center}
    .progress{height:10px;background:#eee;border-radius:8px;overflow:hidden}
    .badge{display:inline-block;background:#eef;border-radius:6px;padding:4px 8px;margin:4px 6px 0 0}
    .goal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
    .goal.active{display:flex}
    .goal-card{background:#fff;border-radius:12px;padding:24px;width:420px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <strong>xAPI Gamify (GitHub Pages)</strong>
      <span class="muted">– last opp en RISE xAPI .zip og start</span>
    </div>
    <div class="row">
      <button id="btnClear" class="btn">Tøm cache</button>
      <a href="https://github.com/" target="_blank" class="btn">Åpne i GitHub</a>
    </div>
  </header>
  <div class="wrap">
    <aside>
      <h3>1) Last opp RISE .zip</h3>
      <input id="file" type="file" accept=".zip"/>
      <div id="result" class="muted" style="margin-top:8px">Ingen fil valgt</div>
      <div style="margin-top:12px">
        <label>Kursnavn/slug</label><br/>
        <input id="slug" value="demo-course" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"/>
      </div>
      <div style="margin-top:12px">
        <label>Startfil</label><br/>
        <select id="start" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
          <option>index.html</option>
          <option>story.html</option>
          <option>launch.html</option>
        </select>
      </div>
      <div style="margin-top:12px">
        <button id="btnLaunch" class="btn">2) Start kurs</button>
      </div>
      <hr style="margin:16px 0"/>
      <h3>Gamification</h3>
      <div class="progress"><div id="bar" style="width:0;height:100%;background:#3b82f6"></div></div>
      <p><strong id="xp">0</strong> XP</p>
      <div id="badges"></div>
      <h4 style="margin-top:12px">Siste checkmarks</h4>
      <ul id="checks"><li class="muted">Ingen enda</li></ul>
      <h4>Simulator</h4>
      <div class="row">
        <button class="btn" data-sim="experienced">experienced</button>
        <button class="btn" data-sim="answered-ok">answered ✓</button>
        <button class="btn" data-sim="answered-ko">answered ✗</button>
        <button class="btn" data-sim="completed">completed</button>
        <button class="btn" data-sim="passed">passed 100%</button>
      </div>
      <p class="muted" style="margin-top:8px">Simulatoren sender xAPI-lignende events til overlayet, slik at du kan teste uten ekte LRS.</p>
    </aside>
    <main>
      <iframe id="player" title="Course will appear here"></iframe>
    </main>
  </div>

  <div class="goal" id="goal">
    <div class="goal-card">
      <h2>Gratulerer! Kurs bestått</h2>
      <p>Du har nå <span id="xp2">0</span> XP og nye badges:</p>
      <div id="badges2"></div>
      <div style="margin-top:16px" class="row">
        <button class="btn" onclick="document.getElementById('goal').classList.remove('active')">Lukk</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script>
  const XP = { attempt:1, correct:5, module:20, pass:50 }
  const state = { xp:0, checkmarks:{}, badges:new Set() }

  const xpEl = document.getElementById('xp'), bar = document.getElementById('bar')
  const badgesEl = document.getElementById('badges'), badges2 = document.getElementById('badges2')
  const checksEl = document.getElementById('checks'), goal = document.getElementById('goal')
  const player = document.getElementById('player')

  // Register service worker so we can serve uploaded course files + intercept /xapi
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(()=>console.log('SW registered'))
      .catch(err=>console.warn('SW failed', err))
    navigator.serviceWorker.addEventListener('message', ev => {
      if (ev.data && ev.data.type === 'xapi') handleEvent(ev.data.event)
    })
  }

  function handleEvent(e){
    if (e.verb==='progressed' || e.verb==='experienced'){ state.checkmarks[e.objectId] = true }
    if (e.verb==='answered'){
      if (e.success){ state.xp += XP.correct; flash() } else { state.xp += XP.attempt }
    }
    if (e.verb==='completed'){ state.xp += XP.module; confettiLight() }
    if (e.verb==='passed'){
      state.xp += XP.pass; confettiFull()
      state.badges.add('first-completion')
      if (e.score && e.score.raw===e.score.max){ state.badges.add('perfect-score') }
      goal.classList.add('active')
    }
    render()
  }

  function render(){
    xpEl.textContent = state.xp
    document.getElementById('xp2').textContent = state.xp
    const done = Object.values(state.checkmarks).filter(Boolean).length
    const total = Math.max(1, Object.keys(state.checkmarks).length || 6)
    bar.style.width = Math.min(100, Math.round(done/total*100)) + '%'
    checksEl.innerHTML = ''
    const items = Object.entries(state.checkmarks).filter(([k,v])=>v).slice(-8)
    if (items.length===0){ checksEl.innerHTML='<li class="muted">Ingen enda</li>' }
    else items.forEach(([k])=>{ const li=document.createElement('li'); li.innerHTML='<span style="color:#24a148;margin-right:6px">✔</span>'+k; checksEl.appendChild(li) })
    badgesEl.innerHTML = badges2.innerHTML = ''
    if (state.badges.size===0){ badgesEl.innerHTML = '<span class="muted">Ingen enda</span>' }
    for (const b of state.badges){
      const text = b==='first-completion'?'Første kurs fullført': b==='perfect-score'?'100 % score': b
      const el=document.createElement('span'); el.className='badge'; el.textContent=text; badgesEl.appendChild(el)
      const el2=document.createElement('span'); el2.className='badge'; el2.textContent=text; badges2.appendChild(el2)
    }
  }
  function flash(){
    const o=document.createElement('div')
    Object.assign(o.style,{position:'fixed',inset:0,background:'rgba(34,197,94,.2)',pointerEvents:'none',transition:'opacity .6s',opacity:'1'})
    document.body.appendChild(o); setTimeout(()=>o.style.opacity='0',50); setTimeout(()=>o.remove(),700)
  }
  function confettiLight(){ confetti({ particleCount: 60, spread: 70, origin:{ y:.6 } }) }
  function confettiFull(){ confetti({ particleCount: 180, spread: 80, origin:{ y:.6 } }) }

  // Upload & cache
  document.getElementById('file').addEventListener('change', async (e)=>{
    const file = e.target.files[0]
    if (!file) return
    const slug = document.getElementById('slug').value || 'demo-course'
    const zip = await JSZip.loadAsync(file)
    const files = []
    let foundStarts = new Set()
    for (const fname of Object.keys(zip.files)){
      const entry = zip.files[fname]
      if (entry.dir) continue
      let data = await entry.async('uint8array')
      let path = '/courses/'+slug+'/'+fname.replace(/^\/+/, '')
      let type = mime(fname)
      // Patch tincan.xml endpoint to /xapi (same origin)
      if (fname.toLowerCase().endswith('tincan.xml')){
        const text = new TextDecoder().decode(data)
        const endpoint = location.origin + '/xapi'
        const patched = text.replace(/<endpoint>[^<]*<\/endpoint>/g, '<endpoint>'+endpoint+'</endpoint>')
        data = new TextEncoder().encode(patched)
        type = 'application/xml'
      }
      files.push({ path, data, type })
      if (/\.(html?|htm)$/i.test(fname)) foundStarts.add(fname)
    }
    navigator.serviceWorker.controller?.postMessage({ type:'cacheCourse', files })
    document.getElementById('result').textContent = 'Opplastet: '+file.name+' • Filer: '+files.length
    // populate start options
    const sel = document.getElementById('start')
    sel.innerHTML = ''
    const sorted = Array.from(foundStarts).sort()
    for (const s of sorted){
      const opt = document.createElement('option'); opt.textContent = s; sel.appendChild(opt)
    }
    if (sorted.length===0){
      const opt = document.createElement('option'); opt.textContent = 'index.html'; sel.appendChild(opt)
    }
  })

  document.getElementById('btnLaunch').addEventListener('click', ()=>{
    const slug = document.getElementById('slug').value || 'demo-course'
    const start = document.getElementById('start').value || 'index.html'
    player.src = '/courses/'+slug+'/'+start
  })

  document.getElementById('btnClear').addEventListener('click', async ()=>{
    const reg = await navigator.serviceWorker.getRegistration()
    if (reg) {
      const keys = await caches.keys()
      for (const k of keys) await caches.delete(k)
      location.reload()
    }
  })

  // Simulator buttons -> send fake xAPI to SW, which bounces to app handler
  document.querySelectorAll('[data-sim]').forEach(btn=>btn.addEventListener('click', (ev)=>{
    const kind = ev.currentTarget.getAttribute('data-sim')
    let event = null
    if (kind==='experienced') event = { verb:'experienced', objectId:'screen-'+Math.ceil(Math.random()*6) }
    if (kind==='answered-ok') event = { verb:'answered', objectId:'q-'+Math.ceil(Math.random()*6), success:true }
    if (kind==='answered-ko') event = { verb:'answered', objectId:'q-'+Math.ceil(Math.random()*6), success:false }
    if (kind==='completed') event = { verb:'completed', objectId:'module-'+Math.ceil(Math.random()*3) }
    if (kind==='passed') event = { verb:'passed', objectId:'exam-1', score:{raw:10,max:10} }
    navigator.serviceWorker.controller?.postMessage({ type:'simulateXapi', event })
  }))

  function mime(name){
    const lower = name.toLowerCase()
    if (lower.endsWith('.html')||lower.endsWith('.htm')) return 'text/html'
    if (lower.endsWith('.js')) return 'text/javascript'
    if (lower.endsWith('.css')) return 'text/css'
    if (lower.endsWith('.json')) return 'application/json'
    if (lower.endsWith('.png')) return 'image/png'
    if (lower.endsWith('.jpg')||lower.endsWith('.jpeg')) return 'image/jpeg'
    if (lower.endsWith('.svg')) return 'image/svg+xml'
    if (lower.endsWith('.mp4')) return 'video/mp4'
    if (lower.endsWith('.mp3')) return 'audio/mpeg'
    if (lower.endsWith('.xml')) return 'application/xml'
    return 'application/octet-stream'
  }
  </script>
</body>
</html>
